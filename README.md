# Flamel
A plugin based free energy estimation tool using [alchemlyb](https://github.com/alchemistry/alchemlyb)

# Installation
1. Download and install alchemlyb
```shell
git clone git@github.com:harlor/alchemlyb.git
cd alchemlyb
pip install .
```
2. Download flamel
```shell
git clone git@github.com:harlor/flamel.git
```

# Usage
Currently only Gromacs parser and uncorrelation by dH/dl is supported!
```
usage: flamel.py [-h] [-t TEMPERATURE] [-p PREFIX] [-q SUFFIX] [-e ESTIMATORS]
                 [-n UNCORR] [-o OUTPUT] [-a SOFTWARE] [-s EQUILTIME]

Collect data and estimate free energy differences

optional arguments:
  -h, --help            show this help message and exit
  -t TEMPERATURE, --temperature TEMPERATURE
                        Temperature in K. Default: 298 K. (default: 298.0)
  -p PREFIX, --prefix PREFIX
                        Prefix for datafile sets, i.e.'dhdl' (default).
                        (default: dhdl)
  -q SUFFIX, --suffix SUFFIX
                        Suffix for datafile sets, i.e. 'xvg' (default).
                        (default: xvg)
  -e ESTIMATORS         Comma separated Estimator methods (default: None)
  -n UNCORR, --uncorr UNCORR
                        The observable to be used for the autocorrelation
                        analysis; either 'dhdl_all' (obtained as a sum over
                        all energy components) or 'dhdl' (obtained as a sum
                        over those energy components that are changing;
                        default) or 'dE'. In the latter case the energy
                        differences dE_{i,i+1} (dE_{i,i-1} for the last
                        lambda) are used. (default: dhdl)
  -o OUTPUT, --output OUTPUT
                        Output methods (default: None)
  -a SOFTWARE, --software SOFTWARE
                        Package's name the data files come from: Gromacs,
                        Sire, Desmond, or AMBER. Default: Gromacs. (default:
                        Gromacs)
  -s EQUILTIME, --skiptime EQUILTIME
                        Discard data prior to this specified time as
                        'equilibration' data. Units picoseconds. Default: 0
                        ps. (default: 0)

```

To read enumerated xvg files lambda_0.xvg, lambda_1.xvg, ... use: 
```shell
flamel.py -p lambda_
```

You should get a similar overview as [alchemical-analysis](https://github.com/MobleyLab/alchemical-analysis).

# How it works
- Step 1: Read the necessary data
- Step 2: Uncorrelate the data
- Step 3: Estimate Free energy differences
- Step 4: Output

Each step is performed in Plugins which can easyly be be replaced by other plugins. 

# Name
In the tradition to associate free energy estimations with alchemnistry it's named after: [Nicolas Flamel](https://en.wikipedia.org/wiki/Nicolas_Flamel)

# Alchemical-analysis vs flamel:
Eventhoug alchemical-analysis is not fully covered by Flamel, it can already reproduce some results calculated using alchemical-analysis:

In fact for TI, BAR, MBAR you should get exaclty the same results:

Example Falmel output:
``` 
------------ --------------------- --------------------- --------------------- --------------------- 
   States           TI (kJ/mol)     TI-CUBIC (kJ/mol)          BAR (kJ/mol)         MBAR (kJ/mol)    
------------ --------------------- --------------------- --------------------- --------------------- 
   0 -- 1         0.080  +-  0.001      0.076  +-  0.001      0.078  +-  0.001      0.078  +-  0.001 
   1 -- 2         0.241  +-  0.002      0.239  +-  0.002      0.238  +-  0.002      0.242  +-  0.001 
   2 -- 3         0.435  +-  0.003      0.431  +-  0.003      0.432  +-  0.003      0.437  +-  0.001 
   3 -- 4         0.666  +-  0.004      0.665  +-  0.004      0.664  +-  0.004      0.665  +-  0.002 
   4 -- 5         0.924  +-  0.006      0.923  +-  0.006      0.924  +-  0.005      0.921  +-  0.002 
   5 -- 6         1.196  +-  0.008      1.198  +-  0.008      1.197  +-  0.008      1.189  +-  0.004 
   6 -- 7         1.432  +-  0.013      1.446  +-  0.013      1.444  +-  0.012      1.420  +-  0.005 
   7 -- 8         1.510  +-  0.018      1.532  +-  0.018      1.534  +-  0.019      1.514  +-  0.008 
   8 -- 9         1.352  +-  0.021      1.365  +-  0.021      1.373  +-  0.022      1.364  +-  0.011 
   9 -- 10        1.044  +-  0.021      1.043  +-  0.021      1.039  +-  0.021      1.027  +-  0.010 
  10 -- 11        0.734  +-  0.018      0.725  +-  0.018      0.723  +-  0.017      0.727  +-  0.008 
  11 -- 12        0.520  +-  0.014      0.509  +-  0.014      0.516  +-  0.013      0.553  +-  0.007 
  12 -- 13        0.423  +-  0.011      0.419  +-  0.011      0.423  +-  0.011      0.449  +-  0.006 
  13 -- 14        0.375  +-  0.010      0.378  +-  0.010      0.373  +-  0.010      0.374  +-  0.005 
  14 -- 15        0.313  +-  0.010      0.312  +-  0.010      0.314  +-  0.010      0.312  +-  0.004 
  15 -- 16        0.265  +-  0.010      0.262  +-  0.010      0.265  +-  0.010      0.261  +-  0.004 
  16 -- 17        0.237  +-  0.009      0.240  +-  0.009      0.236  +-  0.009      0.218  +-  0.003 
  17 -- 18        0.197  +-  0.009      0.197  +-  0.009      0.197  +-  0.009      0.182  +-  0.003 
  18 -- 19        0.152  +-  0.008      0.151  +-  0.008      0.151  +-  0.008      0.149  +-  0.002 
  19 -- 20        0.123  +-  0.006      0.120  +-  0.006      0.124  +-  0.006      0.121  +-  0.002 
  20 -- 21       -0.135  +-  0.006     -0.132  +-  0.006     -0.133  +-  0.005     -0.129  +-  0.003 
  21 -- 22       -0.377  +-  0.005     -0.379  +-  0.005     -0.377  +-  0.005     -0.379  +-  0.003 
  22 -- 23       -0.625  +-  0.006     -0.618  +-  0.006     -0.623  +-  0.006     -0.644  +-  0.003 
  23 -- 24       -0.934  +-  0.008     -0.927  +-  0.008     -0.918  +-  0.007     -0.939  +-  0.004 
  24 -- 25       -1.313  +-  0.010     -1.313  +-  0.010     -1.307  +-  0.010     -1.288  +-  0.005 
  25 -- 26       -1.742  +-  0.012     -1.723  +-  0.012     -1.734  +-  0.012     -1.717  +-  0.006 
  26 -- 27       -1.471  +-  0.011     -1.469  +-  0.011     -1.464  +-  0.011     -1.437  +-  0.005 
  27 -- 28       -1.755  +-  0.014     -1.759  +-  0.014     -1.755  +-  0.014     -1.715  +-  0.006 
  28 -- 29       -2.032  +-  0.014     -2.022  +-  0.014     -2.027  +-  0.014     -2.029  +-  0.006 
  29 -- 30       -2.381  +-  0.014     -2.381  +-  0.014     -2.381  +-  0.014     -2.377  +-  0.007 
  30 -- 31       -2.752  +-  0.013     -2.752  +-  0.013     -2.746  +-  0.013     -2.750  +-  0.007 
  31 -- 32       -3.136  +-  0.012     -3.129  +-  0.012     -3.132  +-  0.012     -3.144  +-  0.008 
  32 -- 33       -3.569  +-  0.015     -3.571  +-  0.015     -3.567  +-  0.015     -3.561  +-  0.008 
  33 -- 34       -4.009  +-  0.016     -4.005  +-  0.016     -4.006  +-  0.016     -4.003  +-  0.009 
  34 -- 35       -4.479  +-  0.016     -4.480  +-  0.016     -4.476  +-  0.016     -4.474  +-  0.010 
  35 -- 36       -4.956  +-  0.017     -4.956  +-  0.017     -4.956  +-  0.017     -4.970  +-  0.011 
  36 -- 37       -5.475  +-  0.019     -5.457  +-  0.019     -5.471  +-  0.019     -5.480  +-  0.014 
------------ --------------------- --------------------- --------------------- --------------------- 
     coul:      -41.141  +-  0.073    -41.072  +-  0.073    -41.073  +-  0.052    -41.038  +-  0.070 
      vdw:       12.221  +-  0.074     12.230  +-  0.074     12.244  +-  0.052     12.203  +-  0.060 
    TOTAL:      -28.920  +-  0.104    -28.842  +-  0.104    -28.829  +-  0.074    -28.835  +-  0.092
```

Alchemical Analysis with the same input files:
```
------------ --------------------- --------------------- --------------------- --------------------- --------------------- ---------------------
   States           TI (kJ/mol)     TI-CUBIC (kJ/mol)         DEXP (kJ/mol)         IEXP (kJ/mol)          BAR (kJ/mol)         MBAR (kJ/mol)   
------------ --------------------- --------------------- --------------------- --------------------- --------------------- ---------------------
   0 -- 1         0.080  +-  0.001      0.078  +-  0.002      0.082  +-  0.002      0.074  +-  0.002      0.078  +-  0.001      0.078  +-  0.001
   1 -- 2         0.241  +-  0.002      0.238  +-  0.002      0.237  +-  0.002      0.239  +-  0.003      0.238  +-  0.002      0.242  +-  0.001
   2 -- 3         0.435  +-  0.003      0.431  +-  0.003      0.432  +-  0.004      0.430  +-  0.004      0.432  +-  0.003      0.437  +-  0.001
   3 -- 4         0.666  +-  0.004      0.664  +-  0.005      0.659  +-  0.006      0.669  +-  0.005      0.664  +-  0.004      0.665  +-  0.002
   4 -- 5         0.924  +-  0.006      0.923  +-  0.007      0.927  +-  0.007      0.922  +-  0.008      0.924  +-  0.005      0.921  +-  0.002
   5 -- 6         1.196  +-  0.008      1.198  +-  0.009      1.186  +-  0.011      1.204  +-  0.012      1.197  +-  0.008      1.189  +-  0.004
   6 -- 7         1.432  +-  0.013      1.446  +-  0.015      1.451  +-  0.016      1.445  +-  0.020      1.444  +-  0.012      1.420  +-  0.005
   7 -- 8         1.510  +-  0.018      1.532  +-  0.021      1.540  +-  0.027      1.514  +-  0.028      1.534  +-  0.019      1.514  +-  0.008
   8 -- 9         1.352  +-  0.021      1.365  +-  0.024      1.377  +-  0.030      1.348  +-  0.035      1.373  +-  0.022      1.364  +-  0.011
   9 -- 10        1.044  +-  0.021      1.043  +-  0.024      1.042  +-  0.027      1.064  +-  0.044      1.039  +-  0.021      1.027  +-  0.010
  10 -- 11        0.734  +-  0.018      0.725  +-  0.021      0.742  +-  0.022      0.692  +-  0.037      0.723  +-  0.017      0.727  +-  0.008
  11 -- 12        0.520  +-  0.014      0.509  +-  0.016      0.526  +-  0.018      0.479  +-  0.019      0.516  +-  0.013      0.553  +-  0.007
  12 -- 13        0.423  +-  0.011      0.419  +-  0.012      0.415  +-  0.014      0.433  +-  0.018      0.423  +-  0.011      0.449  +-  0.006
  13 -- 14        0.375  +-  0.010      0.378  +-  0.012      0.365  +-  0.013      0.385  +-  0.018      0.373  +-  0.010      0.374  +-  0.005
  14 -- 15        0.313  +-  0.010      0.312  +-  0.012      0.320  +-  0.013      0.304  +-  0.019      0.314  +-  0.010      0.312  +-  0.004
  15 -- 16        0.265  +-  0.010      0.262  +-  0.011      0.248  +-  0.013      0.280  +-  0.016      0.265  +-  0.010      0.261  +-  0.004
  16 -- 17        0.237  +-  0.009      0.240  +-  0.010      0.232  +-  0.011      0.247  +-  0.018      0.236  +-  0.009      0.218  +-  0.003
  17 -- 18        0.197  +-  0.009      0.197  +-  0.010      0.200  +-  0.011      0.189  +-  0.014      0.197  +-  0.009      0.182  +-  0.003
  18 -- 19        0.152  +-  0.008      0.150  +-  0.009      0.155  +-  0.011      0.144  +-  0.011      0.151  +-  0.008      0.149  +-  0.002
  19 -- 20        0.123  +-  0.006      0.121  +-  0.007      0.118  +-  0.009      0.124  +-  0.008      0.124  +-  0.006      0.121  +-  0.002
  20 -- 21       -0.135  +-  0.006     -0.134  +-  0.006     -0.139  +-  0.010     -0.131  +-  0.007     -0.133  +-  0.005     -0.129  +-  0.003
  21 -- 22       -0.377  +-  0.005     -0.379  +-  0.006     -0.380  +-  0.007     -0.371  +-  0.008     -0.377  +-  0.005     -0.379  +-  0.003
  22 -- 23       -0.625  +-  0.006     -0.618  +-  0.007     -0.636  +-  0.008     -0.614  +-  0.008     -0.623  +-  0.006     -0.644  +-  0.003
  23 -- 24       -0.934  +-  0.008     -0.927  +-  0.009     -0.893  +-  0.009     -0.958  +-  0.013     -0.918  +-  0.007     -0.939  +-  0.004
  24 -- 25       -1.313  +-  0.010     -1.313  +-  0.011     -1.302  +-  0.016     -1.311  +-  0.013     -1.307  +-  0.010     -1.288  +-  0.005
  25 -- 26       -1.742  +-  0.012     -1.723  +-  0.015     -1.731  +-  0.016     -1.728  +-  0.019     -1.734  +-  0.012     -1.717  +-  0.006
  26 -- 27       -1.471  +-  0.011     -1.469  +-  0.013     -1.442  +-  0.014     -1.482  +-  0.017     -1.464  +-  0.011     -1.437  +-  0.005
  27 -- 28       -1.755  +-  0.014     -1.759  +-  0.016     -1.778  +-  0.020     -1.736  +-  0.020     -1.755  +-  0.014     -1.715  +-  0.006
  28 -- 29       -2.032  +-  0.014     -2.022  +-  0.017     -2.047  +-  0.022     -2.003  +-  0.020     -2.027  +-  0.014     -2.029  +-  0.006
  29 -- 30       -2.381  +-  0.014     -2.381  +-  0.016     -2.360  +-  0.022     -2.408  +-  0.019     -2.381  +-  0.014     -2.377  +-  0.007
  30 -- 31       -2.752  +-  0.013     -2.752  +-  0.015     -2.773  +-  0.020     -2.724  +-  0.017     -2.746  +-  0.013     -2.750  +-  0.007
  31 -- 32       -3.136  +-  0.012     -3.129  +-  0.014     -3.121  +-  0.018     -3.143  +-  0.018     -3.132  +-  0.012     -3.144  +-  0.008
  32 -- 33       -3.569  +-  0.015     -3.571  +-  0.017     -3.578  +-  0.020     -3.572  +-  0.024     -3.567  +-  0.015     -3.561  +-  0.008
  33 -- 34       -4.009  +-  0.016     -4.005  +-  0.019     -4.007  +-  0.026     -4.004  +-  0.022     -4.006  +-  0.016     -4.003  +-  0.009
  34 -- 35       -4.479  +-  0.016     -4.481  +-  0.018     -4.476  +-  0.024     -4.480  +-  0.023     -4.476  +-  0.016     -4.474  +-  0.010
  35 -- 36       -4.956  +-  0.017     -4.953  +-  0.019     -4.986  +-  0.026     -4.936  +-  0.026     -4.956  +-  0.017     -4.970  +-  0.011
  36 -- 37       -5.475  +-  0.019     -5.466  +-  0.020     -5.438  +-  0.026     -5.524  +-  0.029     -5.471  +-  0.019     -5.480  +-  0.014
------------ --------------------- --------------------- --------------------- --------------------- --------------------- ---------------------
  Coulomb:      -41.141  +-  0.073    -41.082  +-  0.074    -41.087  +-  0.078    -41.124  +-  0.078    -41.073  +-  0.052    -41.038  +-  0.070
  vdWaals:       12.221  +-  0.074     12.233  +-  0.074     12.255  +-  0.069     12.189  +-  0.091     12.244  +-  0.052     12.203  +-  0.060
    TOTAL:      -28.920  +-  0.104    -28.849  +-  0.105    -28.832  +-  0.104    -28.936  +-  0.120    -28.829  +-  0.074    -28.835  +-  0.092
```
